import streamlit as st
from datetime import datetime
import json
from config import APP_NAME, APP_TAGLINE, MODES, AVATAR_STYLES
from database import NuvexaDB
from assistant import NuvexaAssistant
from shopping import ShoppingEngine

st.set_page_config(
    page_title=APP_NAME,
    page_icon="🤖",
    layout="wide",
    initial_sidebar_state="expanded"
)

st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    
    * {
        font-family: 'Inter', sans-serif;
    }
    
    .stApp {
        background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    }
    
    .main-header {
        font-size: 4rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 0;
        letter-spacing: -2px;
        animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
        from { filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5)); }
        to { filter: drop-shadow(0 0 30px rgba(118, 75, 162, 0.8)); }
    }
    
    .tagline {
        text-align: center;
        color: #a8b2d1;
        font-size: 1.3rem;
        margin-top: -10px;
        margin-bottom: 40px;
        font-weight: 300;
    }
    
    .assistant-avatar {
        font-size: 5rem;
        text-align: center;
        margin: 30px 0;
        animation: float 3s ease-in-out infinite;
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    .mode-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        padding: 15px;
        margin: 10px 0;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .mode-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
    }
    
    .product-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 25px;
        margin: 15px 0;
        transition: all 0.3s ease;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
        border-color: rgba(102, 126, 234, 0.5);
    }
    
    .cart-item {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        padding: 15px;
        border-radius: 15px;
        margin: 10px 0;
        border: 1px solid rgba(102, 126, 234, 0.3);
        backdrop-filter: blur(10px);
    }
    
    .stButton>button {
        border-radius: 25px;
        font-weight: 600;
        padding: 10px 30px;
        transition: all 0.3s ease;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .stButton>button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    [data-testid="stSidebar"] {
        background: linear-gradient(180deg, rgba(15, 12, 41, 0.95) 0%, rgba(48, 43, 99, 0.95) 100%);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .stChatMessage {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 15px;
        margin: 10px 0;
    }
    
    .stTextInput>div>div>input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        color: white;
        padding: 15px;
        backdrop-filter: blur(10px);
    }
    
    .stTextInput>div>div>input:focus {
        border-color: rgba(102, 126, 234, 0.8);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    
    h1, h2, h3, h4, h5, h6 {
        color: #e6f1ff;
    }
    
    p, span, div {
        color: #a8b2d1;
    }
    
    .metric-card {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        padding: 20px;
        border-radius: 15px;
        border: 1px solid rgba(102, 126, 234, 0.3);
        text-align: center;
    }
    
    [data-testid="stMetricValue"] {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
    }
    
    .tip-box {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 15px;
        border-radius: 12px;
        border-left: 4px solid #667eea;
        margin: 10px 0;
    }
    
    .success-message {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
</style>
""", unsafe_allow_html=True)

if 'db' not in st.session_state:
    st.session_state.db = NuvexaDB()
    st.session_state.user_id = st.session_state.db.get_or_create_user("User")
    st.session_state.ai_assistant = NuvexaAssistant()
    st.session_state.shopping_engine = ShoppingEngine()
    st.session_state.current_mode = 'assistant'
    st.session_state.messages = []
    st.session_state.show_products = False
    st.session_state.search_results = []
    st.session_state.cart_open = False

def load_conversation_history():
    history = st.session_state.db.get_conversation_history(st.session_state.user_id, st.session_state.current_mode)
    st.session_state.messages = [{"role": role, "content": content} for role, content in history]

def save_message(role, content):
    st.session_state.db.save_message(st.session_state.user_id, st.session_state.current_mode, content, role)

def switch_mode(new_mode):
    st.session_state.current_mode = new_mode
    st.session_state.ai_assistant.set_mode(new_mode)
    load_conversation_history()
    st.session_state.show_products = False

def add_to_cart(product):
    st.session_state.db.add_to_cart(st.session_state.user_id, product['name'], product['price'], product['image'], product['description'])
    st.success(f"✨ Added {product['name']} to cart!")

def get_cart_total():
    items = st.session_state.db.get_cart_items(st.session_state.user_id)
    return sum(item[2] * item[5] for item in items)

def checkout():
    items = st.session_state.db.get_cart_items(st.session_state.user_id)
    if items:
        total = get_cart_total()
        order_items = [{"name": item[1], "price": item[2], "qty": item[5]} for item in items]
        order_id = st.session_state.db.create_order(st.session_state.user_id, order_items, total)
        st.session_state.db.clear_cart(st.session_state.user_id)
        return order_id, total
    return None, 0

st.markdown(f'<h1 class="main-header">✨ {APP_NAME}</h1>', unsafe_allow_html=True)
st.markdown(f'<p class="tagline">{APP_TAGLINE}</p>', unsafe_allow_html=True)

with st.sidebar:
    st.markdown("### ⚙️ Settings")
    
    st.markdown("#### 🎭 Your Assistant")
    avatar_style = st.selectbox("Avatar Style", AVATAR_STYLES, index=0, label_visibility="collapsed")
    
    avatar_map = {
        "Stylized Futuristic Human": "🤖",
        "Realistic Human": "👨‍💼",
        "Anime Style": "😊",
        "Cartoon Style": "🎭",
        "Minimalist Icon": "●"
    }
    avatar_emoji = avatar_map.get(avatar_style, "🤖")
    st.markdown(f'<div class="assistant-avatar">{avatar_emoji}</div>', unsafe_allow_html=True)
    st.caption(f"💫 {avatar_style}")
    
    st.divider()
    
    st.markdown("#### 🎯 Assistant Mode")
    for mode_key, mode_info in MODES.items():
        is_active = mode_key == st.session_state.current_mode
        col1, col2 = st.columns([1, 4])
        with col1:
            st.markdown(f"### {mode_info['icon']}")
        with col2:
            if st.button(mode_info['name'], key=f"btn_{mode_key}", use_container_width=True, type="primary" if is_active else "secondary"):
                switch_mode(mode_key)
                st.rerun()
    
    current_mode_info = MODES[st.session_state.current_mode]
    st.markdown(f'<div class="tip-box">📝 {current_mode_info["description"]}</div>', unsafe_allow_html=True)
    
    st.divider()
    
    cart_items = st.session_state.db.get_cart_items(st.session_state.user_id)
    st.markdown(f"#### 🛒 Shopping Cart ({len(cart_items)})")
    
    if cart_items:
        cart_total = get_cart_total()
        st.markdown(f'<div class="metric-card"><div style="font-size:2.5rem;font-weight:700;color:#667eea;">${cart_total:.2f}</div><div style="color:#a8b2d1;">Total Amount</div></div>', unsafe_allow_html=True)
        st.write("")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("👁️ View Cart", use_container_width=True):
                st.session_state.cart_open = not st.session_state.cart_open
        with col2:
            if st.button("✅ Checkout", use_container_width=True, type="primary"):
                order_id, total = checkout()
                if order_id:
                    st.success(f"🎉 Order #{order_id} placed! Total: ${total:.2f}")
                    st.balloons()
                    st.rerun()
    else:
        st.info("🛒 Your cart is empty")
    
    st.divider()
    
    orders = st.session_state.db.get_user_orders(st.session_state.user_id, limit=3)
    if orders:
        st.markdown("#### 📦 Recent Orders")
        for order in orders:
            order_id, items, total, status, created = order
            st.markdown(f'<div class="cart-item">Order #{order_id}<br><strong>${total:.2f}</strong></div>', unsafe_allow_html=True)

col1, col2 = st.columns([2, 1])

with col1:
    st.markdown(f"## {MODES[st.session_state.current_mode]['icon']} {MODES[st.session_state.current_mode]['name']} Mode")
    
    if not st.session_state.messages:
        load_conversation_history()
    
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.write(message["content"])
    
    prompt = st.chat_input("💬 Message NUVEXA...")
    if prompt:
        st.session_state.messages.append({"role": "user", "content": prompt})
        save_message("user", prompt)
        
        if st.session_state.current_mode == 'shopping' and st.session_state.ai_assistant.analyze_shopping_intent(prompt):
            product_query = st.session_state.ai_assistant.extract_product_query(prompt)
            st.session_state.search_results = st.session_state.shopping_engine.search_products(product_query)
            st.session_state.show_products = True
        
        conversation_history = [(msg["role"], msg["content"]) for msg in st.session_state.messages[:-1]]
        response = st.session_state.ai_assistant.chat(prompt, conversation_history)
        st.session_state.messages.append({"role": "assistant", "content": response})
        save_message("assistant", response)
        st.rerun()

with col2:
    if st.session_state.show_products and st.session_state.search_results:
        st.markdown("### 🛍️ Products Found")
        for idx, product in enumerate(st.session_state.search_results):
            st.markdown(f"""
            <div class="product-card">
                <div style="font-size: 4rem; text-align: center; margin-bottom: 15px;">{product['image']}</div>
                <h3 style="color: #e6f1ff; margin-bottom: 10px;">{product['name']}</h3>
                <p style="color: #a8b2d1; margin-bottom: 15px;">{product['description']}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 1.8rem; font-weight: 700; color: #667eea;">${product['price']:.2f}</span>
                    <span style="color: #fbbf24;">⭐ {product['rating']}</span>
                </div>
                <p style="color: #8b92a8; margin-top: 10px; font-size: 0.9rem;">📍 {product['source']}</p>
            </div>
            """, unsafe_allow_html=True)
            if st.button("🛒 Add to Cart", key=f"add_{idx}", use_container_width=True):
                add_to_cart(product)
                st.rerun()
            st.write("")
    elif st.session_state.cart_open:
        st.markdown("### 🛒 Your Cart")
        cart_items = st.session_state.db.get_cart_items(st.session_state.user_id)
        if cart_items:
            for item in cart_items:
                cart_id, name, price, image, description, qty = item
                st.markdown(f"""
                <div class="cart-item">
                    <div style="font-size: 2rem; margin-bottom: 5px;">{image}</div>
                    <strong style="color: #e6f1ff;">{name}</strong><br>
                    <span style="color: #667eea; font-size: 1.2rem; font-weight: 600;">${price:.2f}</span>
                    <span style="color: #a8b2d1;"> × {qty}</span>
                </div>
                """, unsafe_allow_html=True)
                if st.button("🗑️ Remove", key=f"remove_{cart_id}"):
                    st.session_state.db.remove_from_cart(cart_id)
                    st.rerun()
            st.divider()
            st.markdown(f'<div class="metric-card"><div style="font-size:2rem;font-weight:700;color:#667eea;">${get_cart_total():.2f}</div><div style="color:#a8b2d1;">Cart Total</div></div>', unsafe_allow_html=True)
        else:
            st.info("🛒 Your cart is empty")
    else:
        st.markdown("### 💡 Quick Tips")
        tips = {
            'assistant': ["📅 Ask me to help plan your day", "🔍 Request research on any topic", "💼 Get advice on projects"],
            'shopping': ["🛍️ Tell me what you want to buy", "⚖️ Ask me to compare products", "🛒 I'll add items to your cart"],
            'therapist': ["💭 Share what's on your mind", "❤️ Talk through your feelings", "👂 I'm here to listen"],
            'builder': ["🏗️ Describe what you want to build", "📋 Ask for project breakdowns", "📊 Get material lists and pricing"]
        }
        for tip in tips.get(st.session_state.current_mode, []):
            st.markdown(f'<div class="tip-box">{tip}</div>', unsafe_allow_html=True)

st.divider()
st.markdown('<p style="text-align: center; color: #8b92a8; font-size: 0.9rem;">✨ NUVEXA v1.0 - Your Living AI Assistant | Powered by OpenAI 🚀</p>', unsafe_allow_html=True)
